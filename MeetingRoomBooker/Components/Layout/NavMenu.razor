@using MeetingRoomBooker.Services
@using MeetingRoomBooker.Models
@inject IBookingService BookingService
@inject NavigationManager Navigation

<div class="top-row ps-3 navbar navbar-dark">
    <div class="container-fluid">
        <button title="Navigation menu" class="navbar-toggler" @onclick="ToggleNavMenu">
            <span class="navbar-toggler-icon"></span>
        </button>
    </div>
</div>

<div class="@NavMenuCssClass nav-scrollable" @onclick="ToggleNavMenu">
    <nav class="flex-column">
        <div class="nav-item px-3">
            <NavLink class="nav-link" href="" Match="NavLinkMatch.All">
                <span class="bi bi-house-door-fill-nav-menu" aria-hidden="true"></span> ホーム
            </NavLink>
        </div>
        <div class="nav-item px-3">
            <NavLink class="nav-link" href="reservation">
                <span class="bi bi-plus-square-fill-nav-menu" aria-hidden="true"></span> 会議室予約
            </NavLink>
        </div>
        <div class="nav-item px-3">
            <NavLink class="nav-link" href="schedule">
                <span class="bi bi-calendar-event-nav-menu" aria-hidden="true"></span> 予約カレンダー
            </NavLink>
        </div>

        <div class="nav-separator"></div>

        @if (currentUser != null)
        {
            <div class="user-profile-item px-3">
                <div class="user-profile-content">
                    <div class="user-avatar" style="background-color: @currentUser.AvatarColor">
                        @currentUser.Name.Substring(0, 1)
                        <span class="status-dot"></span>
                    </div>
                    <span class="user-name">@currentUser.Name</span>
                </div>
                <div class="logout-link" @onclick="Logout">
                    <span>(Logout)</span>
                </div>
            </div>
        }
        else
        {
            <div class="nav-item px-3">
                <NavLink class="nav-link" href="login">
                    <span class="bi bi-box-arrow-in-right-nav-menu" aria-hidden="true"></span> ログイン
                </NavLink>
            </div>
        }
    </nav>
</div>

@code {
    private bool collapseNavMenu = true;
    private string? NavMenuCssClass => collapseNavMenu ? "collapse" : null;
    private UserModel? currentUser;

    protected override void OnInitialized()
    {
        currentUser = BookingService.GetCurrentUser();
    }

    private void ToggleNavMenu()
    {
        collapseNavMenu = !collapseNavMenu;
    }

    private void Logout()
    {
        BookingService.Logout();
        Navigation.NavigateTo("/", forceLoad: true);
    }
}

<style>
    .nav-link {
        white-space: nowrap !important;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .nav-separator {
        height: 1px;
        background-color: rgba(255,255,255,0.1);
        margin: 10px 1rem;
    }

    .user-profile-item {
        padding-top: 10px;
        padding-bottom: 10px;
        color: #d7d7d7;
        overflow: hidden;
    }

    .user-profile-content {
        display: flex;
        align-items: center;
        margin-bottom: 4px;
        white-space: nowrap;
    }

    .user-avatar {
        width: 32px;
        height: 32px;
        min-width: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: white;
        margin-right: 12px;
        position: relative;
        font-size: 0.9rem;
    }

    .status-dot {
        position: absolute;
        bottom: 0;
        right: 0;
        width: 10px;
        height: 10px;
        background-color: #2ea043;
        border: 2px solid #161b22;
        border-radius: 50%;
    }

    .user-name {
        font-size: 0.9rem;
        font-weight: 500;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .logout-link {
        padding-left: 44px;
    }

    .logout-link span {
        font-size: 0.8rem;
        cursor: pointer;
        color: #8b949e;
    }

    .logout-link:hover span {
        color: #ff7b72 !important;
        text-decoration: underline;
    }
</style>