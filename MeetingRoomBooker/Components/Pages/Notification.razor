@page "/notifications"
@using MeetingRoomBooker.Services
@using MeetingRoomBooker.Models
@inject IBookingService BookingService
@inject NavigationManager Navigation

<FluentStack Orientation="Orientation.Vertical" VerticalGap="20">
    <h3 class="gradient-text">NOTIFICATIONS</h3>

    @if (notifications.Count == 0)
    {
        <div class="cyber-card" style="padding: 30px; text-align: center; color: #8b949e;">
            通知はありません。
        </div>
    }
    else
    {
        <div style="display: flex; flex-direction: column; gap: 15px;">
            @foreach (var note in notifications)
            {
                <div class="cyber-card notification-item @(note.IsRead ? "read" : "unread")"
                     @onclick="() => HandleClick(note)"
                     style="cursor: pointer;">

                    <div style="flex-grow: 1;">
                        <div style="margin-bottom: 5px;">
                            <span class="note-date">@note.CreatedAt.ToString("yyyy/MM/dd HH:mm")</span>
                            @if (!note.IsRead)
                            {
                                <span class="new-badge">NEW</span>
                            }
                        </div>
                        <div class="note-message">@note.Message</div>
                    </div>
                    @if (!note.IsRead)
                    {
                        <div style="margin-left: 10px;">
                            <span style="color:#58a6ff; font-size:0.8rem;">確認画面へ ➜</span>
                        </div>
                    }
                </div>
            }
        </div>
    }
</FluentStack>

@code {
    private List<NotificationModel> notifications = new();
    private UserModel? currentUser;

    protected override async Task OnInitializedAsync()
    {
        currentUser = BookingService.GetCurrentUser();
        if (currentUser != null)
        {
            notifications = await BookingService.GetNotificationsAsync(currentUser.Id);
        }
    }

    private async Task HandleClick(NotificationModel note)
    {
        if (!note.IsRead)
        {
            await BookingService.MarkNotificationAsReadAsync(note.Id);
        }
        string dateParam = note.TargetDate.ToString("yyyy-MM-dd");
        Navigation.NavigateTo($"schedule?date={dateParam}");
    }
}

<style>
    .notification-item {
        padding: 15px 20px;
        display: flex;
        align-items: center;
        border-left: 4px solid #30363d;
        transition: background-color 0.2s;
    }

    .notification-item:hover {
        background-color: rgba(255, 255, 255, 0.05) !important;
    }

    .notification-item.unread {
        border-left-color: #58a6ff;
        background: rgba(88, 166, 255, 0.05) !important;
    }

    .note-date {
        font-size: 0.8rem;
        color: #8b949e;
        margin-right: 10px;
    }

    .new-badge {
        background: #f85149;
        color: white;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 0.7rem;
        font-weight: bold;
    }

    .note-message {
        font-size: 1rem;
        color: #e6edf3;
    }
</style>