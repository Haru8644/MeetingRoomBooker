@page "/reservation"
@using MeetingRoomBooker.Models
@using MeetingRoomBooker.Services
@inject IBookingService BookingService
@inject IJSRuntime JSRuntime
@implements IDisposable

<FluentStack Orientation="Orientation.Vertical" VerticalGap="30">
    <div style="width: 100%; display: flex; justify-content: center;">
        <div class="cyber-card" style="padding: 25px; max-width: 800px; width: 100%;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 1px solid #30363d; padding-bottom: 15px;">
                <h3 class="gradient-text" style="margin: 0;">
                    @(editingId == 0 ? "NEW RESERVATION" : "EDIT RESERVATION")
                </h3>
                <div style="text-align: right;">
                    <span class="date-text">@currentDate</span>
                    <span class="cyber-clock">@currentTime</span>
                </div>
            </div>
            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <FluentMessageBar Intent="MessageIntent.Error" Style="margin-bottom: 15px;">
                    @errorMessage
                </FluentMessageBar>
            }
            <FluentStack Orientation="Orientation.Vertical" VerticalGap="20">
                <div>
                    <label style="display:block; margin-bottom:5px; color:#8b949e;">予約者名</label>
                    <FluentTextField @bind-Value="reserveName" Placeholder="名前を入力..." Style="width: 100%;" />
                </div>
                <FluentGrid Spacing="2">
                    <FluentGridItem xs="12" sm="6">
                        <label style="display:block; margin-bottom:5px; color:#8b949e;">利用区分</label>
                        <FluentSelect Items="@typeOptions" @bind-Value="reserveType" Style="width: 100%; min-width: 0;" />
                    </FluentGridItem>
                    <FluentGridItem xs="12" sm="6">
                        <label style="display:block; margin-bottom:5px; color:#8b949e;">利用人数</label>
                        <FluentNumberField @bind-Value="numberOfPeople" Min="1" Style="width: 100%;" />
                    </FluentGridItem>
                </FluentGrid>
                <div>
                    <label style="display:block; margin-bottom:5px; color:#8b949e;">会議室</label>
                    <FluentSelect Items="@roomOptions" @bind-Value="selectedRoom" Style="width: 100%;" />
                </div>
                <div>
                    <label style="display:block; margin-bottom:5px; color:#8b949e;">利用目的 (プロジェクト名など)</label>
                    <FluentTextField @bind-Value="reservePurpose" Placeholder="例：〇〇プロジェクト定例、来客対応など" Style="width: 100%;" />
                </div>
                <div>
                    <label style="display:block; margin-bottom:5px; color:#8b949e;">利用日</label>
                    <FluentDatePicker @bind-Value="reserveDate" Style="width: 100%;" />
                </div>
                <FluentGrid Spacing="2">
                    <FluentGridItem xs="6">
                        <label style="display:block; margin-bottom:5px; color:#8b949e;">開始時間</label>
                        <FluentTimePicker @bind-Value="startTime" Style="width: 100%;" />
                    </FluentGridItem>
                    <FluentGridItem xs="6">
                        <label style="display:block; margin-bottom:5px; color:#8b949e;">終了時間</label>
                        <FluentTimePicker @bind-Value="endTime" Style="width: 100%;" />
                    </FluentGridItem>
                </FluentGrid>
                <div style="margin-top: 15px; display: flex; gap: 10px;">
                    <button class="cyber-button-primary" style="padding: 8px 20px; border-radius: 4px; cursor: pointer;" @onclick="OnSubmit">
                        @(editingId == 0 ? "予約を追加" : "変更を保存")
                    </button>
                    @if (editingId != 0)
                    {
                        <FluentButton Appearance="Appearance.Neutral" OnClick="OnCancelEdit">キャンセル</FluentButton>
                    }
                </div>
            </FluentStack>
        </div>
    </div>
    <div>
        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
            <h3 style="margin: 0;">RESERVATION LIST</h3>
            <span style="background: #30363d; padding: 2px 8px; border-radius: 10px; font-size: 0.8em;">@reservationHistory.Count</span>
        </div>
        <FluentSearch Placeholder="Search..." @bind-Value="searchText" Style="width: 100%; max-width: 400px; margin-bottom: 20px;" />
        <div style="display: flex; flex-wrap: wrap; gap: 20px;">
            @foreach (var item in FilteredList)
            {
                <div class="cyber-card" style="@GetCardStyle(item.Room) width: 300px; padding: 15px; position: relative;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px; align-items: center;">
                        <span style="font-weight: bold; color: @GetRoomColor(item.Room);">@item.Room</span>
                        <span style="font-size: 0.75em; padding: 2px 8px; border-radius: 4px; background: @(item.Type == "来客" ? "#b32121" : "#1b6ec2"); color: white; white-space: nowrap;">
                            @item.Type
                        </span>
                    </div>

                    <h4 style="margin: 0 0 5px 0; font-size: 1.2em;">@item.Name</h4>
                    <div style="font-size: 0.85em; color: #a0a0a0; margin-bottom: 10px; min-height: 1.2em;">
                        @(string.IsNullOrEmpty(item.Purpose) ? "(目的未入力)" : item.Purpose)
                    </div>

                    <div style="color: #8b949e; font-size: 0.9em; margin-bottom: 5px;">
                        @item.Date.ToString("yyyy/MM/dd")
                    </div>
                    <div style="font-size: 1.1em; font-weight: bold; margin-bottom: 10px;">
                        @item.StartTime.ToString("HH:mm") <span style="color:#58a6ff">➜</span> @item.EndTime.ToString("HH:mm")
                        <span style="font-size: 0.8em; font-weight: normal; color: #8b949e; margin-left: 10px;">(@item.NumberOfPeople 名)</span>
                    </div>

                    <div style="display: flex; justify-content: flex-end; gap: 10px;">
                        <FluentButton IconStart="@(new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size16.Edit())"
                                      OnClick="() => OnEdit(item)" Size="Size.Small">Edit</FluentButton>
                        <FluentButton IconStart="@(new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size16.Delete())"
                                      class="cyber-button-danger"
                                      Appearance="Appearance.Outline"
                                      OnClick="() => OnRemove(item)" Size="Size.Small">Del</FluentButton>
                    </div>
                </div>
            }
        </div>
    </div>

</FluentStack>

@code {
    private string currentTime = "";
    private string currentDate = "";
    private System.Threading.Timer? _timer;
    private string reserveName = "";
    private string selectedRoom = "大会議室";
    private int numberOfPeople = 1;
    private DateTime? reserveDate = DateTime.Today;
    private DateTime? startTime = DateTime.Today.AddHours(9);
    private DateTime? endTime = DateTime.Today.AddHours(10);
    private string reserveType = "社内";
    private string reservePurpose = "";
    private string searchText = "";
    private string errorMessage = "";
    private int editingId = 0;
    private List<string> roomOptions = new() { "大会議室", "小会議室", "応接室" };
    private List<string> typeOptions = new() { "社内", "来客" };
    private List<ReservationModel> reservationHistory = new();
    private IEnumerable<ReservationModel> FilteredList =>reservationHistory.Where(x => string.IsNullOrEmpty(searchText) || x.Name.Contains(searchText) || x.Room.Contains(searchText) || x.Purpose.Contains(searchText));
    
    protected override async Task OnInitializedAsync()
    {
        reservationHistory = await BookingService.GetReservationsAsync();
        UpdateTime(null);
        _timer = new System.Threading.Timer(UpdateTime, null, 0, 1000);
    }
    private void UpdateTime(object? state) { var now = DateTime.Now; currentTime = now.ToString("HH:mm:ss"); currentDate = now.ToString("yyyy/MM/dd dddd"); InvokeAsync(StateHasChanged); }
    public void Dispose() { _timer?.Dispose(); }

    private void OnEdit(ReservationModel item)
    {
        editingId = item.Id;
        reserveName = item.Name;
        selectedRoom = item.Room;
        numberOfPeople = item.NumberOfPeople;
        reserveDate = item.Date;
        startTime = item.StartTime;
        endTime = item.EndTime;
        reserveType = item.Type ?? "社内";
        reservePurpose = item.Purpose ?? "";
        errorMessage = "";
    }
    private void OnCancelEdit()
    {
        editingId = 0; reserveName = ""; numberOfPeople = 1; reservePurpose = ""; reserveType = "社内"; errorMessage = "";
    }
    private async Task OnSubmit()
    {
        errorMessage = "";
        if (string.IsNullOrEmpty(reserveName) || reserveDate == null || startTime == null || endTime == null) { errorMessage = "必須項目を入力してください"; return; }
        DateTime dtStart = reserveDate.Value.Date + startTime.Value.TimeOfDay;
        DateTime dtEnd = reserveDate.Value.Date + endTime.Value.TimeOfDay;
        if (dtEnd <= dtStart) { errorMessage = "終了時間は開始時間より後にしてください"; return; }

        if (dtStart.Hour < 9 || dtEnd > new DateTime(dtEnd.Year, dtEnd.Month, dtEnd.Day, 22, 0, 0))
        {
            errorMessage = "予約可能な時間は 09:00 ～ 22:00 です。";
            return;
        }

        var currentList = await BookingService.GetReservationsAsync();
        if (currentList.Any(x => x.Id != editingId && x.Room == selectedRoom && x.StartTime < dtEnd && x.EndTime > dtStart))
        {
            errorMessage = "その時間は既に予約が入っています！";
            return;
        }
        var model = new ReservationModel { Id = editingId, Name = reserveName, Room = selectedRoom, NumberOfPeople = numberOfPeople, Date = reserveDate.Value, StartTime = dtStart, EndTime = dtEnd, Type = reserveType, Purpose = reservePurpose };
        if (editingId == 0) await BookingService.AddReservationAsync(model); else await BookingService.UpdateReservationAsync(model);
        reservationHistory = await BookingService.GetReservationsAsync();
        OnCancelEdit();
    }
    private async Task OnRemove(ReservationModel item) { if (await JSRuntime.InvokeAsync<bool>("confirm", $"削除しますか？")) { await BookingService.RemoveReservationAsync(item); reservationHistory = await BookingService.GetReservationsAsync(); if (editingId == item.Id) OnCancelEdit(); } }
    private string GetRoomColor(string room) { return room == "大会議室" ? "#58a6ff" : (room == "小会議室" ? "#3fb950" : "#a371f7"); }
    private string GetCardStyle(string room) { return $"border-left: 4px solid {GetRoomColor(room)};"; }
}