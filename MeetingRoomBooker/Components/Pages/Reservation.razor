@page "/"
@page "/reservation"
@using Microsoft.EntityFrameworkCore
@using MeetingRoomBooker
@using MeetingRoomBooker.Models
@inject AppDbContext DbContext

<h3>会議室予約</h3>

<div class="p-3 border rounded mb-4">
    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger">@errorMessage</div>
    }

    <div class="mb-3">
        <label>予約者名</label>
        <input class="form-control" @bind="reserveName" />
    </div>

    <div class="mb-3">
        <label>会議室</label>
        <select class="form-control" @bind="selectedRoom">
            <option value="大会議室">大会議室</option>
            <option value="小会議室">小会議室</option>
        </select>
    </div>

    <div class="mb-3">
        <label>利用日</label>
        <input type="date" class="form-control" @bind="reserveDate" />
    </div>

    <div class="row">
        <div class="col">
            <label>開始時間</label>
            <input type="time" class="form-control" @bind="startTime" />
        </div>
        <div class="col">
            <label>終了時間</label>
            <input type="time" class="form-control" @bind="endTime" />
        </div>
    </div>
    <br />

    <button class="btn btn-primary" @onclick="OnSubmit">予約を追加する</button>
</div>

<h4 class="mt-4 mb-3">
    予約一覧
    <span class="badge bg-secondary">@reservationHistory.Count 件</span>
</h4>

@if (reservationHistory.Count == 0)
{
    <div class="alert alert-light text-center shadow-sm" role="alert">
        予約はまだありません。<br>
        <span class="small text-muted">新しい予約を追加してください。</span>
    </div>
}
else
{
    <div class="row">
        @foreach (var item in reservationHistory)
        {
            <div class="col-12 col-md-6 mb-3">
                <div class="card shadow-sm border-start border-5 @GetBorderColor(item.Room)">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h5 class="card-title mb-0 fw-bold">@item.Room</h5>

                            <button class="btn btn-outline-danger btn-sm" @onclick="() => OnRemove(item)">
                                削除
                            </button>
                        </div>

                        <h6 class="card-subtitle mb-3 text-muted">
                            @item.Date.ToString("yyyy/MM/dd")
                        </h6>

                        <div class="d-flex align-items-center mb-3">
                            <span class="fs-4 fw-bold text-dark">
                                @item.StartTime.ToString("HH:mm")
                            </span>
                            <span class="mx-2 text-muted">～</span>
                            <span class="fs-4 fw-bold text-dark">
                                @item.EndTime.ToString("HH:mm")
                            </span>
                        </div>

                        <div class="border-top pt-2">
                            <span class="small text-muted">予約者:</span>
                            <span class="fw-bold ms-1">@item.Name</span>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
}

@code {
    private string reserveName = "";
    private string errorMessage = "";
    private string selectedRoom = "大会議室"; 
    private DateTime reserveDate = DateTime.Today;
    private DateTime startTime = DateTime.Today.AddHours(9);  
    private DateTime endTime = DateTime.Today.AddHours(10);   

    private List<ReservationModel> reservationHistory = new List<ReservationModel>();

    protected override async Task OnInitializedAsync()
    {
        await DbContext.Database.EnsureDeletedAsync();
        await DbContext.Database.EnsureCreatedAsync();
        reservationHistory = await DbContext.Reservations.ToListAsync();
    }

    private async Task OnSubmit()
    {
        errorMessage = "";
        if (string.IsNullOrWhiteSpace(reserveName)) return;
        if (endTime <= startTime)
        {
            errorMessage = "エラー：終了時間は開始時間より後に設定してください！";
            return;
        }

        DateTime dtStart = new DateTime(reserveDate.Year, reserveDate.Month, reserveDate.Day, startTime.Hour, startTime.Minute, 0);
        DateTime dtEnd = new DateTime(reserveDate.Year, reserveDate.Month, reserveDate.Day, endTime.Hour, endTime.Minute, 0);

        if (dtEnd <= dtStart)
        {
            errorMessage = "エラー：終了時間は開始時間より後に設定してください！";
            return;
        }

        bool isBatting = await DbContext.Reservations
             .AnyAsync(x =>
                 x.Room == selectedRoom &&   
                 x.Date == reserveDate &&    
                 x.StartTime < dtEnd &&      
                 x.EndTime > dtStart         
             );

        if (isBatting)
        {
            errorMessage = "エラー：その日は既に予約が入っています！";
            return;
        }

        var newRes = new ReservationModel
        {
            Name = reserveName,
            Room = selectedRoom,
            Date = reserveDate,
            StartTime = dtStart,
            EndTime = dtEnd
        };

        DbContext.Reservations.Add(newRes); 
        await DbContext.SaveChangesAsync(); 
        reservationHistory = await DbContext.Reservations.ToListAsync();
        reserveName = "";
    }

    private async Task OnRemove(ReservationModel item)
    {
        DbContext.Reservations.Remove(item);
        await DbContext.SaveChangesAsync();
        reservationHistory.Remove(item);
    }

    private string GetBorderColor(string roomName)
    {
        if (roomName == "大会議室") return "border-primary";
        if (roomName == "小会議室") return "border-success"; 
        return "border-warning"; 
    }
}