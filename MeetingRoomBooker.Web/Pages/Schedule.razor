@page "/schedule"
@using MeetingRoomBooker.Shared.Models
@using MeetingRoomBooker.Services
@inject IBookingService BookingService
@inject IJSRuntime JSRuntime

<FluentStack Orientation="Orientation.Vertical" VerticalGap="20" Style="width: 100%; padding-bottom: 50px;">
    <h3 class="gradient-text">RESERVATION CALENDAR</h3>

    <div style="display: flex; justify-content: center; gap: 20px; flex-wrap: wrap;">
        <div class="cyber-card" style="padding: 15px; text-align: center; width: 300px;">
            <FluentCalendar @bind-Value="selectedDate" @bind-Value:after="OnDateChanged" />
        </div>

        <div class="cyber-card" style="padding: 15px; width: 300px; display: flex; flex-direction: column; justify-content: space-between;">
            <div>
                <label style="color: #8b949e; font-size: 0.9em; display: block; margin-bottom: 5px;">View Mode</label>
                <div class="view-switcher">
                    <button class="@(currentView == ViewMode.Day ? "active" : "")" @onclick="() => ChangeView(ViewMode.Day)">Day</button>
                    <button class="@(currentView == ViewMode.Week ? "active" : "")" @onclick="() => ChangeView(ViewMode.Week)">Week</button>
                    <button class="@(currentView == ViewMode.Month ? "active" : "")" @onclick="() => ChangeView(ViewMode.Month)">Month</button>
                </div>
            </div>
            <div style="margin-top: 15px;">
                <label style="color: #8b949e; font-size: 0.9em;">Current Range</label>
                <div style="font-weight: bold; color: #58a6ff; font-size: 1.1em;">
                    @GetRangeLabel()
                </div>
            </div>
        </div>
    </div>

    <div class="cyber-card" style="padding: 20px; overflow-x: auto; width: 100%; min-height: 500px;">
        <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 20px;">
            <h4 style="margin: 0;">TIMELINE</h4>
            <div style="display: flex; gap: 10px; align-items: center; font-size: 0.8em;">
                <span style="color: #8b949e;">Legend:</span>
                <span style="padding: 2px 8px; border-radius: 4px; background: #1b6ec2; color: white;">社内</span>
                <span style="padding: 2px 8px; border-radius: 4px; background: #b32121; color: white;">来客</span>
                <span style="padding: 2px 8px; border-radius: 4px; border: 1px solid #d29922; color: #d29922;">My Booking</span>
                <span style="color: #ffbf00; font-weight: bold; margin-left: 5px;">⚠ Warning</span>
            </div>
        </div>

        <div class="timeline-container">
            <div class="timeline-header">
                <div class="room-label-placeholder"></div>
                <div class="time-scale">
                    @foreach (var tick in GetTimeTicks())
                    {
                        <div class="time-mark" style="left: @tick.Position%">@tick.Label</div>
                    }
                </div>
            </div>

            @foreach (var room in roomList)
            {
                <div class="timeline-row">
                    <div class="room-label" style="border-left: 4px solid @GetRoomColor(room)">@room</div>
                    <div class="timeline-track">
                        @foreach (var tick in GetTimeTicks())
                        {
                            <div class="grid-line" style="left: @tick.Position%"></div>
                        }

                        @foreach (var item in GetRenderItems(room))
                        {
                            @if (item.IsMoreButton)
                            {
                                <div class="booking-block more-btn"
                                     style="@item.Style"
                                     @onclick="() => ShowListModal(item.HiddenBookings)">
                                    <span style="font-size: 0.8em; font-weight: bold;">+@item.Count More</span>
                                </div>
                            }
                            else
                            {
                                <div class="booking-block @(IsMyBooking(item.Booking!) ? "my-booking" : "")"
                                     style="@item.Style"
                                     @onclick="() => ShowDetail(item.Booking!)">

                                    @if (item.HasConflict)
                                    {
                                        <div class="warning-icon" title="重複しています">⚠</div>
                                    }

                                    <div class="block-content">
                                        <span class="block-text name">@item.Booking!.Name</span>
                                        @if (currentView == ViewMode.Day)
                                        {
                                            <span class="block-text purpose">@(string.IsNullOrEmpty(item.Booking.Purpose) ? "-" : item.Booking.Purpose)</span>
                                        }
                                    </div>
                                </div>
                            }
                        }
                    </div>
                </div>
            }
        </div>
    </div>
</FluentStack>

@if (selectedList != null)
{
    <div class="modal-backdrop" @onclick="CloseListModal">
        <div class="modal-content cyber-card" @onclick:stopPropagation="true" style="max-width: 400px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #30363d; padding-bottom: 10px;">
                <h3 style="margin: 0; font-size: 1.2rem;">Events List</h3>
                <button class="close-btn" @onclick="CloseListModal">×</button>
            </div>
            <div style="max-height: 300px; overflow-y: auto;">
                @foreach (var b in selectedList)
                {
                    <div class="list-item" @onclick="() => { CloseListModal(); ShowDetail(b); }">
                        <div style="display:flex; justify-content:space-between;">
                            <span style="font-weight:bold; color: @GetRoomColor(b.Room)">@b.Room</span>
                            <span style="font-size:0.8em; color:#8b949e">@b.StartTime.ToString("HH:mm")-@b.EndTime.ToString("HH:mm")</span>
                        </div>
                        <div style="font-weight:bold;">@b.Name</div>
                        @if (HasConflict(b))
                        {
                            <div style="color: #ffbf00; font-size: 0.8em;">⚠ 重複あり</div>
                        }
                    </div>
                }
            </div>
        </div>
    </div>
}

@if (selectedBooking != null)
{
    <div class="modal-backdrop" @onclick="CloseDetail">
        <div class="modal-content cyber-card" @onclick:stopPropagation="true">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                <div>
                    @if (!isEditing)
                    {
                        <span style="background: @GetTypeColor(selectedBooking.Type); padding: 4px 10px; border-radius: 4px; font-size: 0.8em; color: white;">
                            @selectedBooking.Type
                        </span>
                        <h2 style="margin: 10px 0 5px 0;">@selectedBooking.Name</h2>
                        @if (HasConflict(selectedBooking))
                        {
                            <div style="color: #ffbf00; margin-top: 5px; font-weight: bold;">
                                ⚠ この予約は他の予約と時間が重複しています
                            </div>
                        }
                    }
                    else
                    {
                        <h3 class="gradient-text">EDIT MODE</h3>
                    }
                </div>
                <button class="close-btn" @onclick="CloseDetail">×</button>
            </div>

            @if (!isEditing)
            {
                <div class="detail-row">
                    <label>日時</label>
                    <div>
                        @selectedBooking.Date.ToString("yyyy/MM/dd")<br />
                        <span style="font-size: 1.2em; font-weight: bold;">
                            @selectedBooking.StartTime.ToString("HH:mm") ～ @selectedBooking.EndTime.ToString("HH:mm")
                        </span>
                    </div>
                </div>
                <div class="detail-row">
                    <label>会議室</label>
                    <div style="color: @GetRoomColor(selectedBooking.Room); font-weight: bold;">@selectedBooking.Room</div>
                </div>
                <div class="detail-row">
                    <label>利用人数</label>
                    <div>@selectedBooking.NumberOfPeople 名</div>
                </div>
                <div class="detail-row">
                    <label>参加メンバー</label>
                    <div style="color: #d29922;">
                        @GetParticipantNames(selectedBooking.ParticipantIds)
                    </div>
                </div>
                <div class="detail-row">
                    <label>利用目的</label>
                    <div>@(string.IsNullOrEmpty(selectedBooking.Purpose) ? "(なし)" : selectedBooking.Purpose)</div>
                </div>

                <div style="margin-top: 20px; display:flex; justify-content: flex-end; gap: 10px;">
                    @if (IsMyBooking(selectedBooking))
                    {
                        <FluentButton IconStart="@(new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size16.Edit())"
                                      OnClick="StartEdit">Edit</FluentButton>
                        <FluentButton IconStart="@(new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size16.Delete())"
                                      class="cyber-button-danger" Appearance="Appearance.Outline"
                                      OnClick="DeleteBooking">Del</FluentButton>
                    }
                    <FluentButton Appearance="Appearance.Neutral" OnClick="CloseDetail">閉じる</FluentButton>
                </div>
            }
            else
            {
                <FluentStack Orientation="Orientation.Vertical" VerticalGap="15">
                    <FluentTextField @bind-Value="editName" Label="予約名" Style="width: 100%;" />
                    <FluentSelect Items="@roomList" @bind-Value="editRoom" Label="会議室" Style="width: 100%;" />
                    <FluentGrid Spacing="2">
                        <FluentGridItem xs="6"><FluentTimePicker @bind-Value="editStart" Label="開始" Style="width:100%" /></FluentGridItem>
                        <FluentGridItem xs="6"><FluentTimePicker @bind-Value="editEnd" Label="終了" Style="width:100%" /></FluentGridItem>
                    </FluentGrid>
                    <FluentTextField @bind-Value="editPurpose" Label="目的" Style="width: 100%;" />

                    <div style="margin-top: 15px; display:flex; gap: 10px; justify-content: flex-end;">
                        <button class="cyber-button-primary" style="padding: 5px 15px; border-radius: 4px;" @onclick="SaveEdit">Save</button>
                        <FluentButton Appearance="Appearance.Neutral" OnClick="CancelEdit">Cancel</FluentButton>
                    </div>
                </FluentStack>
            }
        </div>
    </div>
}

@code {
    [SupplyParameterFromQuery] public string? Date { get; set; }
    private List<ReservationModel> allReservations = new();
    private List<UserModel> allUsers = new();
    private List<string> roomList = new() { "大会議室", "小会議室", "応接室" };
    private UserModel? currentUser;
    private DateTime selectedDateValue = DateTime.Today;
    private DateTime? selectedDate
    {
        get => selectedDateValue;
        set { if (value.HasValue) { selectedDateValue = value.Value; OnDateChanged(); } }
    }
    private enum ViewMode { Day, Week, Month }
    private ViewMode currentView = ViewMode.Day;
    private ReservationModel? selectedBooking = null;
    private List<ReservationModel>? selectedList = null;
    private bool isEditing = false;
    private string editName = "";
    private string editRoom = "";
    private DateTime? editStart;
    private DateTime? editEnd;
    private string editPurpose = "";
    protected override async Task OnInitializedAsync()
    {
        await LoadData();
        BookingService.OnChange += async () => { await LoadData(); await InvokeAsync(StateHasChanged); };
    }
    private async Task LoadData()
    {
        allReservations = await BookingService.GetReservationsAsync();
        currentUser = BookingService.GetCurrentUser();
        try { allUsers = await BookingService.GetAllUsersAsync(); } catch { }
    }
    protected override void OnParametersSet()
    {
        if (!string.IsNullOrEmpty(Date) && DateTime.TryParse(Date, out DateTime parsedDate)) selectedDateValue = parsedDate;
    }
    private async Task OnDateChanged() => await InvokeAsync(StateHasChanged);
    private void ChangeView(ViewMode mode) => currentView = mode;

    private class RenderItem
    {
        public ReservationModel? Booking { get; set; }
        public string Style { get; set; } = "";
        public bool IsMoreButton { get; set; }
        public int Count { get; set; }
        public bool HasConflict { get; set; }
        public List<ReservationModel> HiddenBookings { get; set; } = new();
    }

    private class OverflowBlock
    {
        public DateTime Start { get; set; }
        public DateTime End { get; set; }
        public List<ReservationModel> Items { get; set; } = new();
        public int Count => Items.Count;
    }

    private IEnumerable<RenderItem> GetRenderItems(string room)
    {
        var start = GetViewStartDate();
        var end = GetViewEndDate();
        var bookings = allReservations.Where(x => x.Room == room && x.Date.Date >= start && x.Date.Date <= end).ToList();

        if (currentView == ViewMode.Day)
        {
            var clusters = GetClusters(bookings);
            foreach (var cluster in clusters)
            {
                var lanes = CalculateLanes(cluster);
                int totalLanes = lanes.Count;
                int maxRows = 3;
                bool isOverflow = totalLanes > maxRows;
                int displayRows = isOverflow ? maxRows : totalLanes;
                double heightPercent = (displayRows > 0) ? (100.0 / displayRows) : 100;
                double actualHeight = heightPercent - 2.0;
                int normalLanes = isOverflow ? (maxRows - 1) : totalLanes;

                for (int i = 0; i < normalLanes; i++)
                {
                    foreach (var booking in lanes[i])
                    {
                        yield return new RenderItem
                        {
                            Booking = booking,
                            HasConflict = HasConflict(booking),
                            Style = $"left: {GetTimePosition(booking.StartTime.Hour, booking.StartTime.Minute)}%; width: {GetDurationWidth(booking)}%; background: {GetTypeColor(booking.Type)}; top: {i * heightPercent}%; height: {actualHeight}%; position: absolute; box-sizing: border-box; border-top: 1px solid #161b22; opacity: 0.95;"
                        };
                    }
                }

                if (isOverflow)
                {
                    var overflowItems = new List<ReservationModel>();
                    for (int i = normalLanes; i < lanes.Count; i++)
                    {
                        overflowItems.AddRange(lanes[i]);
                    }

                    foreach (var block in GetOverflowBlocks(overflowItems))
                    {
                        yield return new RenderItem
                        {
                            IsMoreButton = true,
                            Count = block.Count,
                            HiddenBookings = block.Items,
                            Style = $"left: {GetTimePosition(block.Start.Hour, block.Start.Minute)}%; width: {GetDurationWidth(block.Start, block.End)}%; background: #30363d; border: 1px dashed #8b949e; top: {2 * heightPercent}%; height: {actualHeight}%; position: absolute; box-sizing: border-box; display: flex; align-items: center; justify-content: center;"
                        };
                    }
                }
            }
        }
        else
        {
            var grouped = bookings.GroupBy(b => b.Date.Date);
            foreach (var group in grouped)
            {
                var sorted = group.OrderBy(b => b.StartTime).ToList();
                int count = sorted.Count;
                for (int i = 0; i < count; i++)
                {
                    if (i == 2 && count > 3)
                    {
                        var hidden = sorted.Skip(2).ToList();
                        yield return new RenderItem
                        {
                            IsMoreButton = true,
                            Count = hidden.Count,
                            HiddenBookings = hidden,
                            Style = GetGridStyle(group.Key, i, 3) + "background: #30363d; border: 1px dashed #8b949e;"
                        };
                        break;
                    }
                    yield return new RenderItem
                    {
                        Booking = sorted[i],
                        HasConflict = HasConflict(sorted[i]),
                        Style = GetGridStyle(group.Key, i, (count > 3 ? 3 : count)) + $"background: {GetTypeColor(sorted[i].Type)};"
                    };
                }
            }
        }
    }

    private List<List<ReservationModel>> GetClusters(List<ReservationModel> bookings)
    {
        var sorted = bookings.OrderBy(b => b.StartTime).ToList();
        var clusters = new List<List<ReservationModel>>();
        if (!sorted.Any()) return clusters;

        var currentCluster = new List<ReservationModel> { sorted[0] };
        var clusterEnd = sorted[0].EndTime;

        for (int i = 1; i < sorted.Count; i++)
        {
            if (sorted[i].StartTime < clusterEnd)
            {
                currentCluster.Add(sorted[i]);
                if (sorted[i].EndTime > clusterEnd) clusterEnd = sorted[i].EndTime;
            }
            else
            {
                clusters.Add(currentCluster);
                currentCluster = new List<ReservationModel> { sorted[i] };
                clusterEnd = sorted[i].EndTime;
            }
        }
        clusters.Add(currentCluster);
        return clusters;
    }

    private List<List<ReservationModel>> CalculateLanes(List<ReservationModel> cluster)
    {
        var lanes = new List<List<ReservationModel>>();
        foreach (var booking in cluster)
        {
            bool placed = false;
            foreach (var lane in lanes)
            {
                if (lane.Last().EndTime <= booking.StartTime)
                {
                    lane.Add(booking);
                    placed = true;
                    break;
                }
            }
            if (!placed) lanes.Add(new List<ReservationModel> { booking });
        }
        return lanes;
    }

    private IEnumerable<OverflowBlock> GetOverflowBlocks(List<ReservationModel> items)
    {
        if (!items.Any()) yield break;

        var sorted = items.OrderBy(b => b.StartTime).ToList();
        var currentBlock = new OverflowBlock { Start = sorted[0].StartTime, End = sorted[0].EndTime };
        currentBlock.Items.Add(sorted[0]);

        for (int i = 1; i < sorted.Count; i++)
        {
            if (sorted[i].StartTime < currentBlock.End)
            {
                if (sorted[i].EndTime > currentBlock.End) currentBlock.End = sorted[i].EndTime;
                currentBlock.Items.Add(sorted[i]);
            }
            else
            {
                yield return currentBlock;
                currentBlock = new OverflowBlock { Start = sorted[i].StartTime, End = sorted[i].EndTime };
                currentBlock.Items.Add(sorted[i]);
            }
        }
        yield return currentBlock;
    }

    private bool HasConflict(ReservationModel target)
    {
        return allReservations.Any(x => x.Id != target.Id && x.Room == target.Room && x.Date.Date == target.Date.Date && x.StartTime < target.EndTime && x.EndTime > target.StartTime);
    }

    private string GetGridStyle(DateTime date, int index, int totalInStack)
    {
        var viewStart = GetViewStartDate();
        var totalDays = (currentView == ViewMode.Week) ? 7.0 : DateTime.DaysInMonth(viewStart.Year, viewStart.Month);
        var offsetDays = (date - viewStart).TotalDays;
        double left = (offsetDays / totalDays) * 100.0;
        double width = (1.0 / totalDays) * 100.0;
        double height = 100.0 / totalInStack;
        height -= 2;
        double top = index * (100.0 / totalInStack);
        return $"left: {left}%; width: {width}%; top: {top}%; height: {height}%; box-sizing: border-box; border-top: 1px solid #161b22; position: absolute; padding: 0 2px;";
    }

    private void ShowDetail(ReservationModel b) { selectedBooking = b; isEditing = false; }
    private void CloseDetail() { selectedBooking = null; isEditing = false; }
    private void StartEdit()
    {
        editName = selectedBooking!.Name; editRoom = selectedBooking!.Room; editStart = selectedBooking!.StartTime; editEnd = selectedBooking!.EndTime; editPurpose = selectedBooking!.Purpose; isEditing = true;
    }
    private void CancelEdit() => isEditing = false;
    private async Task SaveEdit()
    {
        if (selectedBooking == null) return;
        selectedBooking.Name = editName; selectedBooking.Room = editRoom;
        if (editStart.HasValue) selectedBooking.StartTime = selectedBooking.Date.Date + editStart.Value.TimeOfDay;
        if (editEnd.HasValue) selectedBooking.EndTime = selectedBooking.Date.Date + editEnd.Value.TimeOfDay;
        selectedBooking.Purpose = editPurpose;
        await BookingService.UpdateReservationAsync(selectedBooking); await LoadData(); isEditing = false;
    }
    private async Task DeleteBooking()
    {
        if (await JSRuntime.InvokeAsync<bool>("confirm", "本当に削除しますか？")) { if (selectedBooking != null) await BookingService.RemoveReservationAsync(selectedBooking); CloseDetail(); await LoadData(); }
    }
    private void ShowListModal(List<ReservationModel> list) => selectedList = list;
    private void CloseListModal() => selectedList = null;
    private string GetParticipantNames(List<int> ids)
    {
        if (ids == null || !ids.Any()) return "(なし)";
        var names = ids.Select(id => allUsers.FirstOrDefault(u => u.Id == id)?.Name ?? $"User:{id}");
        return string.Join(", ", names);
    }
    private double GetTimePosition(int hour, int minute) { double total = 13 * 60; double cur = (hour - 9) * 60 + minute; return (Math.Max(0, Math.Min(cur, total)) / total) * 100.0; }
    private double GetDurationWidth(ReservationModel b) => GetTimePosition(b.EndTime.Hour, b.EndTime.Minute) - GetTimePosition(b.StartTime.Hour, b.StartTime.Minute);
    private double GetDurationWidth(DateTime start, DateTime end) => GetTimePosition(end.Hour, end.Minute) - GetTimePosition(start.Hour, start.Minute);

    private string GetRangeLabel()
    {
        var s = GetViewStartDate(); var e = GetViewEndDate();
        return currentView == ViewMode.Day ? s.ToString("yyyy/MM/dd (ddd)") : (currentView == ViewMode.Week ? $"{s:MM/dd} - {e:MM/dd}" : s.ToString("yyyy/MM"));
    }
    private DateTime GetViewStartDate()
    {
        if (currentView == ViewMode.Day) return selectedDateValue.Date;
        if (currentView == ViewMode.Week) { var diff = (7 + (selectedDateValue.DayOfWeek - DayOfWeek.Monday)) % 7; return selectedDateValue.AddDays(-1 * diff).Date; }
        return new DateTime(selectedDateValue.Year, selectedDateValue.Month, 1);
    }
    private DateTime GetViewEndDate()
    {
        if (currentView == ViewMode.Day) return selectedDateValue.Date;
        if (currentView == ViewMode.Week) return GetViewStartDate().AddDays(6);
        return GetViewStartDate().AddMonths(1).AddDays(-1);
    }
    private List<TimeTick> GetTimeTicks()
    {
        var list = new List<TimeTick>();
        if (currentView == ViewMode.Day) { for (int h = 9; h <= 22; h++) list.Add(new TimeTick { Label = $"{h}:00", Position = GetTimePosition(h, 0) }); }
        else if (currentView == ViewMode.Week) { var s = GetViewStartDate(); for (int i = 0; i < 7; i++) list.Add(new TimeTick { Label = s.AddDays(i).ToString("dd(ddd)"), Position = (i / 7.0) * 100 }); }
        else { var s = GetViewStartDate(); var d = DateTime.DaysInMonth(s.Year, s.Month); for (int i = 0; i < d; i += 5) list.Add(new TimeTick { Label = (i + 1).ToString(), Position = (i / (double)d) * 100 }); }
        return list;
    }
    private struct TimeTick { public string Label; public double Position; }
    private string GetRoomColor(string r) => r == "大会議室" ? "#58a6ff" : (r == "小会議室" ? "#3fb950" : "#a371f7");
    private string GetTypeColor(string t) => t == "来客" ? "#b32121" : "#1b6ec2";
    private bool IsMyBooking(ReservationModel b) => currentUser != null && (b.UserId == currentUser.Id || b.ParticipantIds.Contains(currentUser.Id));
}

<style>
    .cyber-card {
        -webkit-overflow-scrolling: touch;
        scrollbar-width: thin;
    }

    .cyber-card::-webkit-scrollbar {
        height: 8px;
        width: 8px;
    }

    .cyber-card::-webkit-scrollbar-track {
        background: #0d1117;
        border-radius: 4px;
    }

    .cyber-card::-webkit-scrollbar-thumb {
        background: #30363d;
        border-radius: 4px;
    }

    .cyber-card::-webkit-scrollbar-thumb:hover {
        background: #58a6ff;
    }

    .warning-icon {
        position: absolute;
        top: 2px;
        right: 2px;
        font-size: 14px;
        color: #ffbf00;
        z-index: 10;
        text-shadow: 0 0 3px rgba(0,0,0,0.8);
        animation: pulse 2s infinite;
    }

    @@keyframes pulse {
        0% {
            transform: scale(1);
        }

        50% {
            transform: scale(1.2);
        }

        100% {
            transform: scale(1);
        }
    }

    .timeline-row {
        display: flex;
        height: 120px;
        margin-bottom: 15px;
        align-items: center;
    }

    .more-btn {
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        transition: background 0.2s;
    }

    .more-btn:hover {
        background: #454d55 !important;
    }

    .list-item {
        padding: 10px;
        border-bottom: 1px solid #30363d;
        cursor: pointer;
    }

    .list-item:hover {
        background: rgba(255,255,255,0.05);
    }

    .view-switcher {
        display: flex;
        background: #0d1117;
        border: 1px solid #30363d;
        border-radius: 6px;
        overflow: hidden;
        margin-top: 5px;
    }

    .view-switcher button {
        flex: 1;
        background: transparent;
        border: none;
        color: #8b949e;
        padding: 5px 10px;
        cursor: pointer;
        font-size: 0.9em;
        transition: all 0.2s;
    }

    .view-switcher button.active {
        background: #1b6ec2;
        color: white;
    }

    .view-switcher button:hover:not(.active) {
        background: rgba(255,255,255,0.05);
        color: white;
    }

    .timeline-container {
        position: relative;
        min-width: 800px;
        width: 100%;
    }

    .timeline-header {
        display: flex;
        height: 30px;
        border-bottom: 1px solid #30363d;
        margin-bottom: 10px;
    }

    .room-label-placeholder {
        width: 100px;
        flex-shrink: 0;
    }

    .time-scale {
        flex-grow: 1;
        position: relative;
    }

    .time-mark {
        position: absolute;
        transform: translateX(-50%);
        font-size: 0.8em;
        color: #8b949e;
        white-space: nowrap;
    }

    .room-label {
        width: 100px;
        font-weight: bold;
        flex-shrink: 0;
        padding-left: 10px;
        color: #e6edf3;
        font-size: 0.9rem;
    }

    .timeline-track {
        flex-grow: 1;
        position: relative;
        height: 100%;
        background: rgba(255,255,255,0.03);
        border-radius: 4px;
    }

    .grid-line {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 1px;
        background: rgba(255,255,255,0.08);
    }

    .booking-block {
        border-radius: 2px;
        color: white;
        padding: 0 4px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.5);
        transition: transform 0.1s;
        z-index: 5;
        overflow: hidden;
        position: absolute;
    }

    .booking-block:hover {
        z-index: 100;
        box-shadow: 0 4px 10px rgba(0,0,0,0.8);
    }

    .my-booking {
        border: 2px solid #d29922 !important;
        box-shadow: 0 0 10px rgba(210, 153, 34, 0.6) !important;
        z-index: 6;
    }

    .block-content {
        display: flex;
        flex-direction: column;
        justify-content: center;
        height: 100%;
    }

    .block-text {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        line-height: 1.2;
        display: block;
    }

    .name {
        font-weight: bold;
        font-size: 0.85em;
    }

    .purpose {
        font-size: 0.75em;
        opacity: 0.9;
    }

    .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        animation: fadeIn 0.2s;
    }

    .modal-content {
        width: 90%;
        max-width: 500px;
        padding: 30px !important;
        background: #161b22;
        border: 1px solid #58a6ff;
        box-shadow: 0 0 30px rgba(88, 166, 255, 0.2) !important;
        animation: scaleIn 0.2s;
        max-height: 90vh;
        overflow-y: auto;
    }

    .close-btn {
        background: none;
        border: none;
        color: #8b949e;
        font-size: 1.5rem;
        cursor: pointer;
    }

    .close-btn:hover {
        color: white;
    }

    .detail-row {
        margin-bottom: 15px;
        border-bottom: 1px solid #30363d;
        padding-bottom: 10px;
    }

    .detail-row label {
        display: block;
        font-size: 0.85em;
        color: #8b949e;
        margin-bottom: 4px;
    }

    @@keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    @@keyframes scaleIn {
        from {
            transform: scale(0.9);
        }

        to {
            transform: scale(1);
        }
    }
</style>