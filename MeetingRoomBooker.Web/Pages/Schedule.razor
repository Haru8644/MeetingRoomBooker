@page "/schedule"
@using MeetingRoomBooker.Shared.Models
@using System.Globalization
@inject IBookingService BookingService
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation

<div class="schedule-container">
    <div class="sidebar-panel">
        <h3 class="gradient-text title-text">CALENDAR</h3>

        <div class="cyber-card-enhanced control-card">
            <div class="calendar-header">
                <button class="nav-btn" @onclick="PrevMonth">◀</button>
                <div class="current-month-label">@displayMonth.ToString("yyyy年 M月")</div>
                <button class="nav-btn" @onclick="NextMonth">▶</button>
            </div>

            <div class="calendar-grid header-row">
                <div class="week-day">日</div><div class="week-day">月</div><div class="week-day">火</div><div class="week-day">水</div><div class="week-day">木</div><div class="week-day">金</div><div class="week-day">土</div>
            </div>

            <div class="calendar-grid body-rows">
                @foreach (var day in calendarDays)
                {
                    var isSelected = (day.Date == selectedDateValue.Date);
                    var isToday = (day.Date == DateTime.Today);
                    var isOtherMonth = (day.Month != displayMonth.Month);
                    var hasMyBooking = allReservations.Any(r => r.Date.Date == day.Date && IsMyBooking(r));

                    <div class="calendar-cell
                                        @(isSelected ? "selected" : "")
                                        @(isOtherMonth ? "other-month" : "")
                                        @(hasMyBooking ? "has-my-booking" : "")"
                         @onclick="() => SelectDate(day)">

                        <span class="day-number">@day.Day</span>
                        @if (isToday)
                        {
                            <div class="calendar-today-dot"></div>
                        }
                    </div>
                }
            </div>

            <div class="current-range-text">Selected: <span class="selected-date-highlight">@selectedDateValue.ToString("yyyy/MM/dd")</span></div>

            <div class="legend-box">
                <div class="legend-item"><span class="legend-color internal"></span>社内</div>
                <div class="legend-item"><span class="legend-color visitor"></span>来客</div>
                <div class="legend-item"><span class="legend-icon my-border-legend"></span>自分/参加</div>
                <div class="legend-item"><span class="legend-icon today-dot-legend"></span>今日</div>
            </div>
        </div>
    </div>

    <div class="main-list-area">
        @if (isLoading)
        {
            <div class="loading-text">Loading...</div>
        }
        else
        {
            <div @key="selectedDateValue" class="fade-in-list">
                @foreach (var date in GetDisplayDates())
                {
                    if (!HasAnyBooking(date)) continue;
                    <div class="date-group">
                        <div class="sticky-date-header">
                            <div class="date-label-area"><span class="date-year">@date.Year.</span><span class="date-big">@date.ToString("MM/dd")</span><span class="date-week">(@date.ToString("ddd"))</span></div>
                            <button class="timeline-btn" @onclick="() => OpenTimelineModal(date)"><span class="oi oi-bar-chart"></span> Timeline</button>
                        </div>
                        <div class="room-groups">
                            @foreach (var room in roomList)
                            {
                                var bookings = GetBookings(date, room);
                                if (!bookings.Any()) continue;

                                <div class="room-row">
                                    <div class="room-label" data-room="@room" style="border-left: 4px solid @GetRoomColor(room)">@room</div>
                                    <div class="booking-cards">
                                        @foreach (var b in bookings)
                                        {
                                            <div class="booking-card @(IsMyBooking(b) ? "my-booking" : "")"
                                                 data-type="@b.Type"
                                                 style="background: @GetTypeColor(b.Type, true);"
                                                 @onclick="() => ShowDetail(b)">

                                                <div class="type-icon-bg">
                                                    @if (b.Type == "社内")
                                                    {
                                                        <span class="oi oi-briefcase"></span>
                                                    }
                                                    else
                                                    {
                                                        <span class="oi oi-people"></span>
                                                    }
                                                </div>

                                                @if (HasConflict(b))
                                                {
                                                    <div class="warning-icon">⚠</div>
                                                }

                                                <div class="time-badge">@b.StartTime.ToString("HH:mm") - @b.EndTime.ToString("HH:mm")</div>
                                                <div class="card-content">
                                                    <div class="card-title">@b.Name</div>
                                                    <div class="card-desc">@b.Purpose</div>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                }
                <div class="end-of-list">End of list (No more future bookings)</div>
            </div>
        }
    </div>
</div>

@if (selectedBooking != null)
{
    <div class="modal-backdrop" @onclick="CloseDetail" @ontouchmove:stopPropagation="true" style="z-index: 30000 !important;">
        <div class="modal-content cyber-modal-animated" @onclick:stopPropagation="true">
            @if (!isEditing)
            {
                <div class="modal-header">
                    <h3 class="modal-title gradient-text-enhanced" style="background: none !important; -webkit-text-fill-color: transparent !important; background-image: linear-gradient(135deg, #00c6ff, #d53369) !important; -webkit-background-clip: text !important;">@selectedBooking.Name</h3>
                    <button class="close-btn" @onclick="CloseDetail">×</button>
                </div>
                <div class="detail-body">
                    <div class="cyber-detail-row slide-in-right" style="--i:1"><div class="label">日時</div><div class="value value-text">@selectedBooking.Date.ToString("yyyy/MM/dd")<br />@selectedBooking.StartTime.ToString("HH:mm") - @selectedBooking.EndTime.ToString("HH:mm")</div></div>
                    <div class="cyber-detail-row slide-in-right" style="--i:2"><div class="label">会議室</div><div class="value value-text" style="border-left: 4px solid @GetRoomColor(selectedBooking.Room); padding-left: 10px;">@selectedBooking.Room</div></div>
                    <div class="cyber-detail-row slide-in-right" style="--i:3"><div class="label">区分</div><div class="value value-text" style="border-left: 4px solid @GetTypeColor(selectedBooking.Type); padding-left: 10px;">@selectedBooking.Type</div></div>
                    <div class="cyber-detail-row slide-in-right" style="--i:4"><div class="label">目的</div><div class="value value-text">@selectedBooking.Purpose</div></div>
                    <div class="cyber-detail-row slide-in-right" style="--i:5"><div class="label">参加者</div><div class="value value-text">@GetParticipantNames(selectedBooking.ParticipantIds)</div></div>
                </div>
                <div class="modal-footer fade-in" style="animation-delay: 0.3s;">
                    @if (IsOwner(selectedBooking))
                    {
                        <button class="cyber-button-primary" @onclick="StartEdit">編集</button>
                        <button class="cyber-button-danger" @onclick="DeleteBooking">削除</button>
                    }
                    <button class="cyber-button-secondary" @onclick="CloseDetail">閉じる</button>
                </div>
            }
            else
            {
                <div class="modal-header">
                    <h3 class="modal-title gradient-text-enhanced" style="background: none !important; -webkit-text-fill-color: transparent !important; background-image: linear-gradient(135deg, #00c6ff, #d53369) !important; -webkit-background-clip: text !important;">予約の編集</h3>
                </div>
                <div class="fluent-stack-scrollable">
                    <FluentStack Orientation="Orientation.Vertical" VerticalGap="15" Style="padding: 10px;">
                        <div class="fade-in-up" style="--i:1; position: relative; z-index: 80;"><label>予約名</label><FluentTextField @bind-Value="editName" Style="width: 100%;" /></div>
                        <div class="fade-in-up" style="--i:2; position: relative; z-index: 70;"><label>利用日</label><FluentDatePicker @bind-Value="editDate" Style="width: 100%;" /></div>

                        <div class="fade-in-up" style="--i:3; position: relative; z-index: 60;">
                            <label>会議室</label>
                            <div class="selection-group">
                                @foreach (var room in roomList)
                                {
                                    <div class="selection-chip @(editRoom == room ? "active" : "")" @onclick="() => editRoom = room">@room</div>
                                }
                            </div>
                        </div>

                        <div class="fade-in-up" style="--i:4; position: relative; z-index: 50;">
                            <label>区分</label>
                            <div class="selection-group">
                                @foreach (var type in typeList)
                                {
                                    <div class="selection-chip @(editType == type ? "active" : "")" @onclick="() => editType = type">@type</div>
                                }
                            </div>
                        </div>

                        <div class="responsive-grid fade-in-up" style="--i:5; position: relative; z-index: 40;">
                            <div>
                                <label>開始</label>
                                <FluentTimePicker @bind-Value="editStart" @bind-Value:after="OnEditStartChanged" Style="width:100%" />
                            </div>
                            <div>
                                <label>終了</label>
                                <FluentTimePicker @bind-Value="editEnd" Style="width:100%" />
                            </div>
                        </div>

                        <div class="fade-in-up" style="--i:6; position: relative; z-index: 30;">
                            <label>参加メンバー</label>
                            <div class="member-select-box">
                                @foreach (var user in allUsers)
                                {
                                    <div class="participant-item">
                                        <input class="form-check-input" type="checkbox" id="edit_user_@user.Id" checked="@(editParticipantIds.Contains(user.Id))" @onchange="@(e => ToggleEditMember(user.Id, e.Value))">
                                        <label class="form-check-label" for="edit_user_@user.Id" style="display:inline; margin-left:5px; cursor:pointer;">@user.Name</label>
                                    </div>
                                }
                            </div>
                        </div>

                        <div class="fade-in-up" style="--i:7; position: relative; z-index: 20;"><label>目的</label><FluentTextField @bind-Value="editPurpose" Style="width: 100%;" /></div>
                        <div class="fade-in-up" style="--i:8; position: relative; z-index: 10; margin-top: 10px; border-top: 1px solid #30363d; padding-top: 10px;">
                            <FluentCheckbox @bind-Value="sendNotification" Label="参加者に変更を通知する" Style="color: #d53369 !important; --neutral-foreground-rest: #d53369 !important;" />
                        </div>
                    </FluentStack>
                </div>
                <div class="modal-footer">
                    <button class="cyber-button-primary" @onclick="SaveEdit">保存</button>
                    <button class="cyber-button-secondary" @onclick="CancelEdit">キャンセル</button>
                </div>
            }
        </div>
    </div>
}

@if (timelineDate != null)
{
    <div class="modal-backdrop" @onclick="CloseTimelineModal" @ontouchmove:stopPropagation="true" style="z-index: 20000 !important;">
        <div class="modal-content cyber-modal-animated timeline-modal-wide zoom-in-enter" @onclick:stopPropagation="true" style="height: 90vh;">
            <div class="modal-header">
                <h3 class="modal-title gradient-text-enhanced" style="background: none !important; -webkit-text-fill-color: transparent !important; background-image: linear-gradient(135deg, #00c6ff, #d53369) !important; -webkit-background-clip: text !important;">@timelineDate.Value.ToString("yyyy/MM/dd (ddd)")</h3>
                <button class="close-btn" @onclick="CloseTimelineModal">×</button>
            </div>

            <div class="legend-box" style="margin: 0 15px 10px; padding-top: 10px; border-top: none; border-bottom: 1px solid #30363d;">
                <div class="legend-item"><span class="legend-color internal"></span>社内</div>
                <div class="legend-item"><span class="legend-color visitor"></span>来客</div>
                <div class="legend-item"><span class="legend-icon my-border-legend"></span>自分</div>
                <div class="legend-item"><span class="legend-icon warning">⚠</span>重複</div>
            </div>

            <div class="detail-body" style="padding: 0; overflow: auto; flex-grow: 1;">
                <div class="timeline-container">
                    <div class="timeline-header">
                        <div class="header-spacer sticky-element"></div>
                        <div class="time-scale">
                            @foreach (var tick in GetTimeTicks())
                            {
                                <div class="time-mark @(tick.IsFirst ? "first-tick" : "")" style="left: @tick.Position%">@tick.Label</div>
                            }
                        </div>
                    </div>

                    @foreach (var room in roomList)
                    {
                        var roomData = GetTimelineRoomData(room, timelineDate.Value);
                        <div class="timeline-row" style="height: @(roomData.RowHeight)px;">
                            <div class="room-label-tl sticky-element" style="border-left: 4px solid @GetRoomColor(room); height: @(roomData.RowHeight)px;">@room</div>
                            <div class="timeline-track" style="height: @(roomData.RowHeight)px;">
                                @foreach (var tick in GetTimeTicks())
                                {
                                    <div class="grid-line" style="left: @tick.Position%;"></div>
                                }
                                @foreach (var item in roomData.Items)
                                {
                                    <div class="booking-block @(IsMyBooking(item.Booking!) ? "my-booking" : "")"
                                         data-type="@item.Booking!.Type"
                                         style="@item.Style; background: @GetTypeColor(item.Booking!.Type);"
                                         @onclick="() => ShowDetail(item.Booking!)">
                                        @if (item.HasConflict)
                                        {
                                            <div class="warning-icon">⚠</div>
                                        }
                                        <div class="block-content">
                                            <div class="block-text name">@item.Booking!.Name</div>
                                            <div class="block-text purpose">@item.Booking!.Purpose</div>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                </div>
            </div>

            <div class="modal-footer">
                <button class="cyber-button-secondary" @onclick="CloseTimelineModal">閉じる</button>
            </div>
        </div>
    </div>
}

@code {
    [SupplyParameterFromQuery] public int? BookingId { get; set; }
    private DateTime selectedDateValue = DateTime.Today;
    private DateTime displayMonth = DateTime.Today;
    private List<DateTime> calendarDays = new();
    private List<ReservationModel> allReservations = new();
    private List<string> roomList = new() { "大会議室", "小会議室" };
    private List<string> typeList = new() { "社内", "来客" };
    private ReservationModel? selectedBooking;
    private UserModel? currentUser;
    private List<UserModel> allUsers = new();
    private bool isEditing = false;
    private bool isLoading = true;
    private string editName = "", editRoom = "", editType = "", editPurpose = "";
    private DateTime? editDate, editStart, editEnd;
    private List<int> editParticipantIds = new();
    private bool sendNotification = true;
    private DateTime? timelineDate;

    protected override async Task OnInitializedAsync()
    {
        GenerateCalendar();
        await LoadData();
        BookingService.OnChange += async () => { await LoadData(); await InvokeAsync(StateHasChanged); };
    }

    protected override async Task OnParametersSetAsync()
    {
        if (BookingId.HasValue)
        {
            await LoadData();
            var target = allReservations.FirstOrDefault(r => r.Id == BookingId.Value);
            if (target != null)
            {
                selectedDateValue = target.Date;
                displayMonth = target.Date;
                GenerateCalendar();
                ShowDetail(target);
                BookingId = null;
            }
        }
    }

    private void OnEditStartChanged()
    {
        if (editStart.HasValue)
        {
            editEnd = editStart.Value.AddHours(1);
        }
    }

    private void GenerateCalendar()
    {
        calendarDays.Clear();
        var firstDayOfMonth = new DateTime(displayMonth.Year, displayMonth.Month, 1);
        var startDay = firstDayOfMonth.AddDays(-(int)firstDayOfMonth.DayOfWeek);
        for (int i = 0; i < 42; i++) { calendarDays.Add(startDay.AddDays(i)); }
    }

    private void PrevMonth() { displayMonth = displayMonth.AddMonths(-1); GenerateCalendar(); }
    private void NextMonth() { displayMonth = displayMonth.AddMonths(1); GenerateCalendar(); }
    private void SelectDate(DateTime date) { selectedDateValue = date; }

    private async Task LoadData()
    {
        isLoading = true;
        allReservations = await BookingService.GetReservationsAsync();
        currentUser = BookingService.GetCurrentUser();
        try { allUsers = await BookingService.GetAllUsersAsync(); } catch { }
        isLoading = false;
        StateHasChanged();
    }

    private List<DateTime> GetDisplayDates()
    {
        var list = new List<DateTime>();
        var maxDate = selectedDateValue.AddDays(30);
        for (var d = selectedDateValue; d <= maxDate; d = d.AddDays(1)) list.Add(d);
        return list;
    }

    private List<ReservationModel> GetBookings(DateTime date, string room) =>
        allReservations.Where(r => r.Date.Date == date.Date && r.Room == room).OrderBy(r => r.StartTime).ToList();

    private bool HasAnyBooking(DateTime date) => roomList.Any(r => GetBookings(date, r).Any());
    private string GetRoomColor(string r) => r == "大会議室" ? "#58a6ff" : "#3fb950";
    private string GetTypeColor(string type, bool isCard = false) { if (type == "来客") return isCard ? "#00c853" : "#00e676"; return isCard ? "#7b1fa2" : "#d500f9"; }
    private bool IsOwner(ReservationModel b) => currentUser != null && b.UserId == currentUser.Id;

    private bool IsMyBooking(ReservationModel b)
    {
        if (currentUser == null) return false;
        if (b.UserId == currentUser.Id) return true;
        if (b.ParticipantIds != null && b.ParticipantIds.Contains(currentUser.Id)) return true;
        return false;
    }

    private bool HasConflict(ReservationModel t) =>
        allReservations.Any(x => x.Id != t.Id && x.Room == t.Room && x.Date.Date == t.Date.Date && x.StartTime < t.EndTime && x.EndTime > t.StartTime);

    private string GetParticipantNames(List<int> ids)
    {
        if (ids == null) return "";
        var names = ids.Select(id => allUsers.FirstOrDefault(u => u.Id == id)?.Name ?? "").Where(n => !string.IsNullOrEmpty(n));
        return string.Join(", ", names);
    }

    private void ShowDetail(ReservationModel b) { selectedBooking = b; isEditing = false; }
    private void CloseDetail() { selectedBooking = null; isEditing = false; }
    private void StartEdit()
    {
        if (selectedBooking == null) return;
        editName = selectedBooking.Name;
        editRoom = selectedBooking.Room;
        editType = selectedBooking.Type;
        editPurpose = selectedBooking.Purpose;
        editDate = selectedBooking.Date;
        editStart = selectedBooking.StartTime;
        editEnd = selectedBooking.EndTime;
        editParticipantIds = new List<int>(selectedBooking.ParticipantIds ?? new List<int>());
        sendNotification = true;
        isEditing = true;
    }

    private void CancelEdit() => isEditing = false;

    private void ToggleEditMember(int userId, object? isChecked)
    {
        if ((bool)(isChecked ?? false))
        {
            if (!editParticipantIds.Contains(userId)) editParticipantIds.Add(userId);
        }
        else
        {
            editParticipantIds.Remove(userId);
        }
    }

    private async Task SaveEdit()
    {
        if (selectedBooking != null)
        {
            selectedBooking.Name = editName;
            selectedBooking.Room = editRoom;
            selectedBooking.Type = editType;
            selectedBooking.Purpose = editPurpose;
            if (editDate.HasValue) selectedBooking.Date = editDate.Value;
            if (editStart.HasValue) selectedBooking.StartTime = selectedBooking.Date.Date + editStart.Value.TimeOfDay;
            if (editEnd.HasValue) selectedBooking.EndTime = selectedBooking.Date.Date + editEnd.Value.TimeOfDay;
            selectedBooking.ParticipantIds = editParticipantIds;

            await BookingService.UpdateReservationAsync(selectedBooking, sendNotification);
        }
        isEditing = false;
    }

    private async Task DeleteBooking()
    {
        if (selectedBooking != null && await JSRuntime.InvokeAsync<bool>("confirm", "削除しますか？"))
        {
            await BookingService.RemoveReservationAsync(selectedBooking);
            selectedBooking = null;
            await LoadData();
        }
    }

    private void OpenTimelineModal(DateTime date) { timelineDate = date; }
    private void CloseTimelineModal() { timelineDate = null; }

    private class RenderItem 
    { 
        public ReservationModel? Booking { get; set; } 
        public string Style { get; set; } = ""; 
        public bool HasConflict { get; set; } 
    }

    private class RoomTimelineData 
    {   
        public List<RenderItem> Items { get; set; } = new(); 
        public double RowHeight { get; set; } 
    }

    private List<dynamic> GetTimeTicks()
    {
        var list = new List<dynamic>();
        for (int h = 9; h <= 22; h++) list.Add(new { Label = $"{h}:00", Position = GetTimePosition(h, 0), IsFirst = (h == 9) });
        return list;
    }

    private double GetTimePosition(int h, int m) => (double)((h - 9) * 60 + m) / (13 * 60) * 100.0;
    private double GetDurationWidth(DateTime s, DateTime e) => GetTimePosition(e.Hour, e.Minute) - GetTimePosition(s.Hour, s.Minute);

    private RoomTimelineData GetTimelineRoomData(string room, DateTime date)
    {
        var bookings = GetBookings(date, room);
        var items = new List<RenderItem>();
        if (!bookings.Any()) return new RoomTimelineData { Items = items, RowHeight = 100 };

        var clusters = new List<List<ReservationModel>>();
        if (bookings.Any())
        {
            var current = new List<ReservationModel> { bookings[0] };
            var end = bookings[0].EndTime;

            for (int i = 1; i < bookings.Count; i++)
            {
                if (bookings[i].StartTime < end)
                {
                    current.Add(bookings[i]);
                    if (bookings[i].EndTime > end) end = bookings[i].EndTime;
                }
                else
                {
                    clusters.Add(current);
                    current = new List<ReservationModel> { bookings[i] };
                    end = bookings[i].EndTime;
                }
            }
            clusters.Add(current);
        }

        int maxLanesInRoom = 0;
        const int LANE_HEIGHT = 60;

        foreach (var cluster in clusters)
        {
            var lanes = new List<List<ReservationModel>>();
            foreach (var b in cluster)
            {
                bool placed = false;
                for (int i = 0; i < lanes.Count; i++)
                {
                    if (lanes[i].Last().EndTime <= b.StartTime)
                    {
                        lanes[i].Add(b);
                        placed = true;
                        break;
                    }
                }
                if (!placed) lanes.Add(new List<ReservationModel> { b });
            }

            if (lanes.Count > maxLanesInRoom) maxLanesInRoom = lanes.Count;

            for (int i = 0; i < lanes.Count; i++)
            {
                foreach (var b in lanes[i])
                {
                    string style =
                        $"left: {GetTimePosition(b.StartTime.Hour, b.StartTime.Minute)}%; " +
                        $"width: {GetDurationWidth(b.StartTime, b.EndTime)}%; " +
                        $"top: {i * LANE_HEIGHT + 5}px; height: {LANE_HEIGHT - 4}px; " +
                        $"position: absolute; border-radius: 4px; padding: 4px 6px; color: white; " +
                        $"overflow: hidden; cursor: pointer; " +
                        $"border: {(IsMyBooking(b) ? "2px solid #d29922;" : "1px solid rgba(255,255,255,0.2)")}; " +
                        $"z-index: 10; display: flex; flex-direction: column; justify-content: center;";

                    items.Add(new RenderItem { Booking = b, HasConflict = HasConflict(b), Style = style });
                }
            }
        }

        double rowHeight = Math.Max(100, maxLanesInRoom * LANE_HEIGHT + 15);
        return new RoomTimelineData { Items = items, RowHeight = rowHeight };
    }
}