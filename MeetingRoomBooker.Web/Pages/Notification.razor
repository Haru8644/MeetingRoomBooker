@page "/notifications"
@using MeetingRoomBooker.Shared.Models
@inject IBookingService BookingService
@inject NavigationManager Navigation

<div class="notification-wrapper fade-in">
    <div class="bg-decoration"></div>

    <div class="notification-container">
        <div class="header-area">
            <h3 class="gradient-text-enhanced title-glow">NOTIFICATION CENTER</h3>
            <button class="clear-btn" @onclick="MarkAllRead">
                <span class="oi oi-check"></span> MARK ALL READ
            </button>
        </div>

        <div class="notification-list">
            @if (!notifications.Any())
            {
                <div class="empty-state fade-in">
                    <div class="empty-icon-wrapper"><span class="oi oi-inbox empty-icon"></span></div>
                    <div class="empty-text">NO NEW SIGNALS</div>
                </div>
            }
            else
            {
                @foreach (var (n, index) in notifications.Select((x, i) => (x, i)))
                {
                    <div class="notif-item @(n.IsRead ? "read" : "unread") @(n.Type == "Warning" ? "warning-item" : "") slide-in-stagger"
                         style="--i:@index"
                         @onclick="() => NavigateToReservation(n)">

                        <div class="icon-area">
                            @if (n.Type == "Warning")
                            {
                                <span class="oi oi-warning text-warning warning-pulse"></span>
                            }
                            else
                            {
                                <span class="oi oi-bell text-info"></span>
                            }
                        </div>
                        <div class="notif-content">
                            <div class="notif-message">@n.Message</div>
                            <div class="notif-meta">
                                <span class="notif-time">@n.CreatedAt.ToString("yyyy/MM/dd HH:mm")</span>
                                <span class="notif-id">ID: @n.Id.ToString("D4")</span>
                            </div>
                        </div>
                        @if (!n.IsRead)
                        {
                            <div class="new-badge">NEW</div>
                        }
                        <div class="hover-arrow">→</div>

                        <div class="action-area" @onclick:stopPropagation="true">
                            <button class="delete-btn" @onclick="() => DeleteNotif(n.Id)">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="white" viewBox="0 0 16 16">
                                    <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z" />
                                    <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z" />
                                </svg>
                            </button>
                        </div>

                    </div>
                }
            }
        </div>
    </div>
</div>

@code {
    private List<NotificationModel> notifications = new();
    private UserModel? currentUser;

    protected override async Task OnInitializedAsync()
    {
        currentUser = BookingService.GetCurrentUser();
        if (currentUser == null)
        {
            Navigation.NavigateTo("/login");
            return;
        }
        await LoadNotifications();
    }

    private async Task LoadNotifications()
    {
        if (currentUser != null)
        {
            notifications = await BookingService.GetNotificationsAsync(currentUser.Id);
        }
    }

    private async Task MarkAllRead()
    {
        foreach (var n in notifications.Where(x => !x.IsRead))
        {
            await BookingService.MarkNotificationAsReadAsync(n.Id);
        }
        await LoadNotifications();
    }

    private async Task DeleteNotif(int id)
    {
        await BookingService.DeleteNotificationAsync(id);
        await LoadNotifications();
    }

    private async Task NavigateToReservation(NotificationModel n)
    {
        if (!n.IsRead)
        {
            await BookingService.MarkNotificationAsReadAsync(n.Id);
        }

        if (n.TargetReservationId.HasValue)
        {
            Navigation.NavigateTo($"/schedule?BookingId={n.TargetReservationId}");
        }
    }
}